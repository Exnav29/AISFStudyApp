{% extends "base.html" %}

{% block content %}
<h1>Quiz</h1>
<div id="pdf-selector">
    <label for="pdf-select">Choose a PDF for the quiz:</label>
    <select id="pdf-select">
        <option value="">Select a PDF</option>
        {% for pdf in pdfs %}
        <option value="{{ pdf }}">{{ pdf }}</option>
        {% endfor %}
    </select>
    <button id="generate-quiz">Generate Quiz</button>
</div>
<div id="quiz-container" style="display: none;">
    <div id="question-container"></div>
    <button id="submit-answer">Submit Answer</button>
    <button id="next-question" style="display: none;">Next Question</button>
</div>
<div id="result-container" style="display: none;">
    <h2>Quiz Complete</h2>
    <p>Your score: <span id="quiz-score"></span>%</p>
</div>

<script>
let questions = [];
let currentQuestionIndex = 0;
let score = 0;

document.addEventListener('DOMContentLoaded', function() {
    const generateQuizButton = document.getElementById('generate-quiz');
    generateQuizButton.addEventListener('click', fetchQuizQuestions);

    document.getElementById('submit-answer').addEventListener('click', submitAnswer);
    document.getElementById('next-question').addEventListener('click', showNextQuestion);
});

function fetchQuizQuestions() {
    const selectedPdf = document.getElementById('pdf-select').value;
    if (!selectedPdf) {
        alert('Please select a PDF first.');
        return;
    }

    fetch('/generate_quiz', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ content: selectedPdf }),
    })
    .then(response => response.json())
    .then(data => {
        questions = data.questions;
        currentQuestionIndex = 0;
        score = 0;
        showQuestion(currentQuestionIndex);
        document.getElementById('quiz-container').style.display = 'block';
        document.getElementById('pdf-selector').style.display = 'none';
    });
}

function showQuestion(index) {
    const question = questions[index];
    const container = document.getElementById('question-container');
    container.innerHTML = `
        <h2>${question.question}</h2>
        ${getAnswerHTML(question)}
    `;
}

function getAnswerHTML(question) {
    switch (question.type) {
        case 'multiple-choice':
            return question.options.map((option, index) => `
                <label>
                    <input type="radio" name="answer" value="${index}">
                    ${option}
                </label>
            `).join('');
        case 'true-false':
            return `
                <label><input type="radio" name="answer" value="true"> True</label>
                <label><input type="radio" name="answer" value="false"> False</label>
            `;
        case 'fill-in-the-blank':
            return '<input type="text" name="answer">';
        case 'matching':
            return `
                <div class="matching-container">
                    ${question.items.map((item, index) => `
                        <div class="matching-item" draggable="true" data-index="${index}">${item}</div>
                    `).join('')}
                </div>
                <div class="matching-slots">
                    ${question.items.map((_, index) => `
                        <div class="matching-slot" data-index="${index}"></div>
                    `).join('')}
                </div>
            `;
        case 'ordering':
            return `
                <div class="ordering-container">
                    ${question.items.map((item, index) => `
                        <div class="ordering-item" draggable="true" data-index="${index}">${item}</div>
                    `).join('')}
                </div>
            `;
        case 'short-answer':
            return '<textarea name="answer" rows="4" cols="50"></textarea>';
        default:
            return '';
    }
}

function submitAnswer() {
    const question = questions[currentQuestionIndex];
    let userAnswer;
    
    switch (question.type) {
        case 'multiple-choice':
        case 'true-false':
            userAnswer = document.querySelector('input[name="answer"]:checked')?.value;
            break;
        case 'fill-in-the-blank':
        case 'short-answer':
            userAnswer = document.querySelector('input[name="answer"], textarea[name="answer"]').value;
            break;
        case 'matching':
            userAnswer = Array.from(document.querySelectorAll('.matching-slot')).map(slot => slot.textContent);
            break;
        case 'ordering':
            userAnswer = Array.from(document.querySelectorAll('.ordering-item')).map(item => item.textContent);
            break;
    }

    if (checkAnswer(question, userAnswer)) {
        score++;
    }

    document.getElementById('submit-answer').style.display = 'none';
    document.getElementById('next-question').style.display = 'block';
}

function checkAnswer(question, userAnswer) {
    switch (question.type) {
        case 'multiple-choice':
            return parseInt(userAnswer) === question.answer;
        case 'true-false':
            return userAnswer === question.answer.toString();
        case 'fill-in-the-blank':
        case 'short-answer':
            return userAnswer.toLowerCase() === question.answer.toLowerCase();
        case 'matching':
        case 'ordering':
            return JSON.stringify(userAnswer) === JSON.stringify(question.correct_order);
        default:
            return false;
    }
}

function showNextQuestion() {
    currentQuestionIndex++;
    if (currentQuestionIndex < questions.length) {
        showQuestion(currentQuestionIndex);
        document.getElementById('submit-answer').style.display = 'block';
        document.getElementById('next-question').style.display = 'none';
    } else {
        showQuizResults();
    }
}

function showQuizResults() {
    const finalScore = (score / questions.length) * 100;
    document.getElementById('quiz-container').style.display = 'none';
    document.getElementById('result-container').style.display = 'block';
    document.getElementById('quiz-score').textContent = finalScore.toFixed(2);

    fetch('/submit_quiz', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ score: finalScore }),
    });

    updateProgress(finalScore / 100);
}

function updateProgress(progress) {
    fetch('/update_progress', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ progress: progress }),
    });
}

// Add drag and drop functionality for matching and ordering questions
document.addEventListener('dragstart', function(event) {
    event.dataTransfer.setData('text/plain', event.target.dataset.index);
});

document.addEventListener('dragover', function(event) {
    event.preventDefault();
});

document.addEventListener('drop', function(event) {
    event.preventDefault();
    const sourceIndex = event.dataTransfer.getData('text');
    const targetElement = event.target.closest('.matching-slot, .ordering-container');
    
    if (targetElement) {
        if (targetElement.classList.contains('matching-slot')) {
            const sourceElement = document.querySelector(`.matching-item[data-index="${sourceIndex}"]`);
            targetElement.textContent = sourceElement.textContent;
        } else if (targetElement.classList.contains('ordering-container')) {
            const items = Array.from(targetElement.children);
            const sourceElement = items[sourceIndex];
            const targetIndex = items.indexOf(event.target.closest('.ordering-item'));
            if (sourceIndex < targetIndex) {
                targetElement.insertBefore(sourceElement, items[targetIndex].nextSibling);
            } else {
                targetElement.insertBefore(sourceElement, items[targetIndex]);
            }
        }
    }
});
</script>
{% endblock %}
